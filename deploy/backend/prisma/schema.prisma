// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ChargingStation {
  id               Int       @id @default(autoincrement())
  ocppIdentifier   String    @unique
  vendor           String?
  model            String?
  firmwareVersion  String?
  serialNumber     String?
  status           String?   // ONLINE/OFFLINE/etc.
  lastHeartbeatAt  DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  // Hardware info
  powerOutputKw    Float?
  maxCurrentAmp    Float?
  maxVoltageV      Float?

  connectors       Connector[]
  sessions         ChargingSession[]
  reservations     Reservation[]
  auditLogs        AuditLog[]    @relation("ChargingStationAuditLogs")
  
  // Reference to the model
  stationModel     StationModel? @relation(fields: [modelId], references: [id])
  modelId          Int?
}

model StationModel {
  id               Int       @id @default(autoincrement())
  name             String    @unique
  vendor           String?
  powerOutputKw    Float?
  maxCurrentAmp    Float?
  maxVoltageV      Float?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  chargingStations ChargingStation[]
}

model Connector {
  id               Int       @id @default(autoincrement())
  chargingStationId Int
  connectorId      Int
  status           String?
  lastStatusAt     DateTime?
  maxPowerKw       Float?

  chargingStation  ChargingStation @relation(fields: [chargingStationId], references: [id])
  sessions         ChargingSession[]

  @@unique([chargingStationId, connectorId])
}

model RfidCard {
  id          Int      @id @default(autoincrement())
  tagId       String   @unique
  status      String   // Active/Blocked/Expired
  validFrom   DateTime?
  validUntil  DateTime?
  userId      Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChargingSession {
  id                 Int       @id @default(autoincrement())
  chargingStationId  Int
  connectorId        Int
  ocppTransactionId  BigInt
  ocppIdTag          String
  startTimestamp     DateTime
  stopTimestamp      DateTime?
  startMeterValue    Int?
  stopMeterValue     Int?
  energyKwh          Float?
  sessionStatus      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  chargingStation    ChargingStation @relation(fields: [chargingStationId], references: [id])
  connector          Connector       @relation(fields: [connectorId], references: [id])
  meterValues        MeterValue[]

  @@unique([chargingStationId, ocppTransactionId])
}

model MeterValue {
  id               Int       @id @default(autoincrement())
  chargingSessionId Int
  timestamp        DateTime
  meterValue       Int
  rawJson          String?

  chargingSession  ChargingSession @relation(fields: [chargingSessionId], references: [id])
}

model Reservation {
  id               Int       @id @default(autoincrement())
  chargingStationId Int
  connectorId      Int?
  ocppReservationId Int
  ocppIdTag        String
  expiryDatetime   DateTime
  status           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  chargingStation  ChargingStation @relation(fields: [chargingStationId], references: [id])

  @@unique([chargingStationId, ocppReservationId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  actionType String   // REMOTE_START, CHANGE_AVAILABILITY, etc.
  targetType String   // STATION, CONNECTOR, SESSION, etc.
  targetId  Int?
  timestamp DateTime @default(now())
  metadata  String?  // JSON string
  status    String?  // SUCCESS, FAILED, PENDING
  request   String?  // JSON string of request payload
  response  String?  // JSON string of response payload
  
  // Relations
  chargingStation ChargingStation? @relation("ChargingStationAuditLogs", fields: [chargingStationId], references: [id])
  chargingStationId Int?
  
  @@index([chargingStationId])
  @@index([timestamp])
}